Thanks to Nick Guerrera from saving me from burden of implementing this stuff.
Code taken from here: http://blogs.msdn.com/nicholg/archive/2006/06/04/617466.aspx